# 语义层使用说明

## 概述

本项目已引入 dbt 语义层，实现了业务指标的集中定义和统一查询。语义层提供了"单一数据源"（Single Source of Truth），确保所有端点（Web UI、API、未来可能的 AI 系统）使用相同的指标定义。

## 架构说明

### 语义层架构

```
语义模型定义 (schema.yml)
    ↓
业务指标定义 (metrics.yml)
    ↓
API 端点 /api/metrics/query
    ↓
Web UI / BI工具 / AI系统
```

### 核心组件

1. **语义模型（Semantic Models）**
   - 位置：`models/dws/schema.yml`
   - 定义了 measures（度量）和 dimensions（维度）
   - 基于 `dws_toll_revenue_daily` 表

2. **业务指标（Metrics）**
   - 位置：`models/metrics.yml`
   - 定义了可复用的业务指标
   - 基于语义模型中的 measures

3. **API 端点**
   - `GET /api/metrics` - 获取所有可用指标
   - `POST /api/metrics/query` - 查询指标数据

## 已定义的指标

### 收入相关指标

- **daily_revenue** - 日收费收入
- **monthly_revenue** - 月收费收入
- **avg_transaction_amount** - 平均交易金额

### 交易量相关指标

- **daily_transactions** - 日交易笔数
- **daily_vehicles** - 日车辆数

### 质量相关指标

- **normal_transaction_rate** - 正常交易率
- **data_quality_rate** - 数据质量率
- **abnormal_transaction_rate** - 异常交易率

## API 使用示例

### 1. 获取所有可用指标

```bash
curl http://localhost:8090/api/metrics
```

响应示例：
```json
[
  {
    "name": "daily_revenue",
    "description": "日收费收入",
    "label": "日收费收入",
    "type": "simple",
    "business_domain": "收费业务",
    "owner": "收费中心",
    "unit": "元"
  }
]
```

### 2. 查询指标数据

#### 基本查询（按日期）

```bash
curl -X POST http://localhost:8090/api/metrics/query \
  -H "Content-Type: application/json" \
  -d '{
    "metric_name": "daily_revenue",
    "start_date": "2025-10-01",
    "end_date": "2025-10-31"
  }'
```

#### 按维度分组查询

```bash
curl -X POST http://localhost:8090/api/metrics/query \
  -H "Content-Type: application/json" \
  -d '{
    "metric_name": "daily_revenue",
    "dimensions": ["city", "station_name"],
    "start_date": "2025-10-01",
    "end_date": "2025-10-31"
  }'
```

#### 带过滤条件的查询

```bash
curl -X POST http://localhost:8090/api/metrics/query \
  -H "Content-Type: application/json" \
  -d '{
    "metric_name": "daily_revenue",
    "dimensions": ["city"],
    "filters": {
      "city": "北京"
    },
    "start_date": "2025-10-01",
    "end_date": "2025-10-31"
  }'
```

#### 查询比率指标

```bash
curl -X POST http://localhost:8090/api/metrics/query \
  -H "Content-Type: application/json" \
  -d '{
    "metric_name": "normal_transaction_rate",
    "dimensions": ["city"],
    "start_date": "2025-10-01",
    "end_date": "2025-10-31"
  }'
```

### 3. Python 客户端示例

```python
import requests

# 获取所有指标
response = requests.get("http://localhost:8090/api/metrics")
metrics = response.json()
print("可用指标:", [m["name"] for m in metrics])

# 查询日收入（按城市）
query = {
    "metric_name": "daily_revenue",
    "dimensions": ["city"],
    "start_date": "2025-10-01",
    "end_date": "2025-10-31"
}
response = requests.post("http://localhost:8090/api/metrics/query", json=query)
data = response.json()
print("查询结果:", data["data"])
print("生成的SQL:", data["query_sql"])
```

## 前端集成示例

### React 组件示例

```jsx
import { useState, useEffect } from 'react'
import api from '../utils/api'

function MetricChart({ metricName, dimensions, filters }) {
  const [data, setData] = useState([])
  const [loading, setLoading] = useState(false)

  useEffect(() => {
    const fetchMetric = async () => {
      setLoading(true)
      try {
        const response = await api.post('/metrics/query', {
          metric_name: metricName,
          dimensions: dimensions,
          filters: filters,
          start_date: '2025-10-01',
          end_date: '2025-10-31'
        })
        setData(response.data.data)
      } catch (error) {
        console.error('查询指标失败:', error)
      } finally {
        setLoading(false)
      }
    }
    fetchMetric()
  }, [metricName, dimensions, filters])

  if (loading) return <div>加载中...</div>

  return (
    <div>
      <h3>{metricName}</h3>
      {/* 渲染图表 */}
      <pre>{JSON.stringify(data, null, 2)}</pre>
    </div>
  )
}
```

## 语义层的优势

### 1. 一致性保证

- **之前**：不同报表中可能对"收入"有不同的计算方式
- **现在**：所有查询都使用 `daily_revenue` 指标，保证一致性

### 2. 易于维护

- **之前**：修改指标定义需要在多个 SQL 文件中修改
- **现在**：只需在 `metrics.yml` 中修改一次，所有端点自动更新

### 3. 业务友好

- **之前**：业务人员需要写 SQL 或依赖数据团队
- **现在**：通过指标名称和维度即可查询，无需了解底层 SQL

### 4. AI 就绪

- **之前**：AI 生成 SQL 时可能使用错误的业务逻辑
- **现在**：AI 可以使用语义层定义的指标，确保计算正确

## 未来扩展

### 1. 集成 MetricFlow

当前实现是简化版，未来可以集成完整的 MetricFlow：

```bash
# 安装 MetricFlow
pip install dbt-metricflow

# 使用 MetricFlow 生成 SQL
mf query --metrics daily_revenue --group-by city --where "transaction_date >= '2025-10-01'"
```

### 2. 支持更多指标类型

- 累计指标（Cumulative）
- 窗口函数指标（Window）
- 转换指标（Conversion）

### 3. 时间粒度支持

- 自动支持日、周、月、年等不同时间粒度
- 自动处理时间维度转换

### 4. 权限控制

- 基于角色的指标访问控制
- 数据行级安全（RLS）

## 注意事项

1. **指标定义变更**：修改指标定义后，需要重新运行 `dbt run` 和重启 API 服务
2. **性能优化**：对于大数据量查询，建议在 DWS 层建立适当的索引
3. **缓存策略**：可以考虑对常用指标查询结果进行缓存
4. **SQL 注入防护**：当前实现已对维度名称进行验证，但建议进一步强化

## 相关文件

- 语义模型定义：`models/dws/schema.yml`
- 指标定义：`models/metrics.yml`
- API 实现：`web_ui/backend/main.py`
- 数据模型：`models/dws/dws_toll_revenue_daily.sql`

